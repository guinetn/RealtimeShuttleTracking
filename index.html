<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">  
	<title>Realtime Shuttle Tracking</title>
	<meta name='viewport' content='width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no' />
  <meta name="description" content="A sample shuttle tracker">

	<script src='https://api.mapbox.com/mapbox.js/v3.2.1/mapbox.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/v3.2.1/mapbox.css' rel='stylesheet' />	
  
  <link rel="stylesheet" type="text/css" href="style.css">
  <meta name="theme-color" content="#2F3BA2" />
  
  <link rel="manifest" href="manifest.json">
  <!-- CODELAB: Add iOS meta tags and icons -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Weather PWA">
<link rel="apple-touch-icon" href="/images/icons/icon-152x152.png">

</head>

<body>

<header>
  <h1 class="header__title">Realtime Shuttle Tracking</h1>
</header>

<div id='map'></div>

<script>

// Map will be centered near "Suez" Le Pecq (France)
let mapCenter = { lat:48.89486, long:2.11367 } 

// My api token
L.mapbox.accessToken = 'pk.eyJ1Ijoibmd1aW5ldCIsImEiOiJjaW1pdXU0M28wMDB1dmxtNTB5aXR4dDh1In0.60moP3OPbtqFBKD-ba4OBQ';

var map = L.mapbox.map('map')
                  .setView([mapCenter.lat, mapCenter.long], 16) 
                  .addLayer(L.mapbox.styleLayer('mapbox://styles/mapbox/streets-v11'));
    
// Add scale (a map without a scale is not!)    
L.control.scale().addTo(map);

// Add SM (Static markers)
var geojson = [
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [2.11403, 48.89041]
    },
    "properties": {
      "title": "Suez Le Pecq",
      "description": "Job place",
      "marker-color": "#004353",
      "marker-size": "large",
      "marker-symbol": "water"      
    }
  },
  {
    "type": "Feature",
    "geometry": {
      "type": "Point",
      "coordinates": [2.1219,48.89823]
    },
    "properties": {
      "title": "RER Le Vesinet/Pecq",      
      "marker-color": "#004353",
      "marker-size": "large",
      "marker-symbol": "rail"      
    }
  }
];

L.mapbox.featureLayer(geojson).addTo(map);



// Let's fake a DM (Dynamic marker)
var DM = L.marker([mapCenter.lat, mapCenter.long], {
    icon: L.mapbox.marker.icon({'marker-color': '#f86767',  'marker-symbol': 'bus'}),
    title: "bus"
});

//  I wanna it to circle around the map center inside a radius of..500m. As 1Â°=60NM=60*1.852km=111.12km. So 500m is 0.5/111.12
let radius = 0.1/60*1.852;
var t = 0;
var animateDM = ()=>{    
    DM.setLatLng(L.latLng( mapCenter.lat  + radius*Math.sin(t), 
    	       						  mapCenter.long + radius*Math.cos(t)));    
    t+=0.02
}
window.setInterval(animateDM, 200);
// Add DM to the map
DM.addTo(map);



// Add my device position (Visitor marker)
var VM = undefined;
function setupVMPosition(position)
{
  console.log("location Latitude: " + position.coords.latitude + " / Longitude: " + position.coords.longitude);
  VM = L.marker([position.coords.latitude, position.coords.longitude], {
      icon: L.mapbox.marker.icon({'marker-color': '#ff0000',  'marker-symbol': 'water'}),
      title: "ME"
    });  

  VM.addTo(map);
}

var animateVM = ()=>{ 
  if (VM != undefined)
    VM.setLatLng(L.latLng( mapCenter.lat  + radius*Math.sin(t), 
    	       						  mapCenter.long + radius*Math.cos(t)));   
}
//window.setInterval(animateVM, 2000);

// Add VM to the map
//VM.addTo(map);


function getLocation() 
{
  // Check whether browser supports Geolocation API or not
  if ("geolocation" in navigator) {
    //  geolocation code 
  	navigator.geolocation.getCurrentPosition(setupVMPosition);    
  }
  else {
     // geolocation not supported
    console.info("This environment doesn't support HTML Geolocation");
  }
}

getLocation();
</script>	

<script>
// https://codelabs.developers.google.com/codelabs/your-first-pwapp/#4
// Register service worker.
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
        .then((reg) => {
          console.log('Service worker registered.', reg);
        });
  });
}</script>
</body>
</html>
